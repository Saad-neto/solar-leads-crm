// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Cliente (Integrador de Energia Solar)
model Cliente {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  senha     String // bcrypt hash
  telefone  String?

  // Customização da Landing Page
  logo           String? // URL S3/Cloudflare ou caminho local
  corPrimaria    String  @default("#10b981") // green-500
  corSecundaria  String  @default("#3b82f6") // blue-500
  subdominio     String  @unique
  whatsapp       String // Formato: 5511999999999

  // Billing
  status     StatusCliente @default(TRIAL)
  planValue  Decimal       @default(997.00) @db.Decimal(10, 2)
  setupPago  Boolean       @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leads    Lead[]
  usuarios Usuario[]

  @@index([email])
  @@index([subdominio])
}

enum StatusCliente {
  TRIAL
  ACTIVE
  PAUSED
  CANCELLED
}

// Lead capturado
model Lead {
  id       String  @id @default(cuid())

  // Informações básicas
  nome     String
  email    String?
  telefone String
  cidade   String?

  // Qualificação via bot
  valorConta String? // Será enum depois da conversa
  tipoImovel String? // Será enum depois da conversa
  interesse  String? // Será enum depois da conversa

  // Tracking / UTM
  origem      String? // meta, google, organico, direto
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // Status e gestão
  status LeadStatus @default(NOVO)
  notas  String?    @db.Text

  // Dados da conversa WhatsApp
  conversaCompleta String? @db.Text // Histórico completo da conversa
  respostasBot     Json? // Armazena objeto com todas as respostas

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  contatadoEm  DateTime?
  qualificadoEm DateTime?

  // Relações
  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId, createdAt])
  @@index([status])
  @@index([telefone])
  @@index([createdAt])
}

enum LeadStatus {
  NOVO
  CONTATADO
  QUALIFICADO
  ORCAMENTO_ENVIADO
  NEGOCIACAO
  FECHADO
  PERDIDO
}

// Usuário do Dashboard (acesso ao painel)
model Usuario {
  id    String @id @default(cuid())
  nome  String
  email String @unique
  senha String // bcrypt hash
  role  Role   @default(USER)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([clienteId])
}

enum Role {
  ADMIN
  USER
}

// Sessão WAHA (WhatsApp)
model SessionWAHA {
  id          String  @id @default(cuid())
  sessionName String  @unique
  qrCode      String? @db.Text
  status      String  @default("STOPPED") // STOPPED, STARTING, SCAN_QR_CODE, WORKING, FAILED

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação com cliente (1:1)
  clienteId String  @unique

  @@index([sessionName])
  @@index([status])
}
